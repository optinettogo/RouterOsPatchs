name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout propre sur main (√©vite detached HEAD)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2Ô∏è‚É£ R√©cup√©ration de la version depuis le tag GitHub
      - name: Get release version
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 3Ô∏è‚É£ Mise √† jour du bloc AUTO-RELEASE dans le README
      - name: Update README download links
        run: |
          VERSION="${{ steps.release.outputs.version }}"

          X86="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/all_packages-x86-$VERSION.zip"
          ISO="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/mikrotik-$VERSION.iso.zip"
          IMG="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/install-image-$VERSION.img.zip"
          VMDK="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-vmdk.zip"
          QCOW2="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION.qcow2.zip"

          sed -i "/<!-- AUTO-RELEASE-START -->/,/<!-- AUTO-RELEASE-END -->/c\
<!-- AUTO-RELEASE-START -->\n\n\
### üìÇ **Tableau des Ressources v7 (Stable)**\n\n\
**Version actuelle : $VERSION**\n\n\
[![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)]($X86)\n\
[![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)]($ISO)\n\
[![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)]($IMG)\n\
[![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)]($VMDK)\n\
[![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)]($QCOW2)\n\n\
<!-- AUTO-RELEASE-END -->" README.md

      # 4Ô∏è‚É£ Commit & push s√©curis√©
      - name: Commit and push README
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "Aucune modification d√©tect√©e."
            exit 0
          fi

          git commit -m "üöÄ Auto-update README links to version ${{ steps.release.outputs.version }}"
          git push origin main
