name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get release version
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update README
        env:
          VERSION: ${{ steps.release.outputs.version }}
        run: |
          # 1. DÃ©finition des balises
          START_B=""
          END_B=""
          
          # 2. GÃ©nÃ©ration du contenu Markdown (On utilise printf pour Ã©viter les soucis de EOF)
          printf "### ðŸ“‚ **Tableau des Ressources (Stable)**\n\n**Version actuelle : $VERSION**\n\n[![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/all_packages-x86-$VERSION.zip) &nbsp; [![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/mikrotik-$VERSION.iso.zip) &nbsp; [![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/install-image-$VERSION-.img.zip) &nbsp; [![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-vmdk.zip) &nbsp; [![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-.qcow2.zip)\n" > /tmp/content.txt

          # 3. Remplacement propre du bloc entre les balises
          sed -i "/$START_B/,/$END_B/{//!d}" README.md
          sed -i "/$START_B/r /tmp/content.txt" README.md

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add README.md
          # On commit seulement s'il y a des changements
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸš€ Auto-update README for version ${{ steps.release.outputs.version }}" && git push origin HEAD:main)
