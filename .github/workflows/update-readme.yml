name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Get release version
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update README download links
        run: |
          VERSION="${{ steps.release.outputs.version }}"

          # DÃ©finition des URLs (VÃ©rifie bien les tirets '-' dans tes noms de fichiers)
          X86="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/all_packages-x86-$VERSION.zip"
          ISO="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/mikrotik-$VERSION.iso.zip"
          IMG="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/install-image-$VERSION-.img.zip"
          VMDK="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-vmdk.zip"
          QCOW2="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-.qcow2.zip"

          # GÃ©nÃ©ration du bloc propre sans erreur de syntaxe
          cat <<EOF > /tmp/auto_block.txt
          ### ðŸ“‚ **Tableau des Ressources v7 (Stable)**

          **Version actuelle : $VERSION**

          [![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)]($X86) &nbsp; [![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)]($ISO) &nbsp; [![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)]($IMG) &nbsp; [![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)]($VMDK) &nbsp; [![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)]($QCOW2)

          EOF

          # Injection dans le README
          awk '
            BEGIN {inblock=0}
            // {inblock=1; system("cat /tmp/auto_block.txt"); next}
            // {inblock=0; next}
            !inblock {print}
          ' README.md > README.new && mv README.new README.md

      - name: Commit and push README
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "Aucune modification dÃ©tectÃ©e."
            exit 0
          fi
          git commit -m "ðŸš€ Auto-update README for version ${{ steps.release.outputs.version }}"
          git push origin HEAD:main
