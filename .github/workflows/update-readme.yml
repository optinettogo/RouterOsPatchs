name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release version
        id: release
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Update README
        env:
          VERSION: ${{ steps.release.outputs.version }}
        run: |
          # 1. DÃ©finition locale et protection des balises
          START_B=''
          END_B=''
          
          # 2. CrÃ©ation du bloc de contenu (VÃ©rifie bien les tirets dans les noms de fichiers)
          cat <<EOF > /tmp/content.txt
          ### ðŸ“‚ **Tableau des Ressources (Stable)**

          **Version actuelle : $VERSION**

          [![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/all_packages-x86-$VERSION.zip) &nbsp; [![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/mikrotik-$VERSION.iso.zip) &nbsp; [![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/install-image-$VERSION-.img.zip) &nbsp; [![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-vmdk.zip) &nbsp; [![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-.qcow2.zip)
          EOF

          # 3. Nettoyage et Injection : On utilise des quotes pour protÃ©ger les variables
          # On supprime tout entre START et END
          sed -i "/$START_B/,/$END_B/{//!d}" README.md
          
          # On injecte le nouveau contenu aprÃ¨s START
          sed -i "/$START_B/r /tmp/content.txt" README.md

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸš€ Auto-update README for version ${{ steps.release.outputs.version }}" || exit 0
          git push origin main
