name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release version
        id: release
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Update README
        env:
          VERSION: ${{ steps.release.outputs.version }}
          # On dÃ©finit le contenu ici pour Ã©viter les erreurs de syntaxe dans le script
          TABLE_CONTENT: |
            ### ðŸ“‚ **Tableau des Ressources (Stable)**
            **Version actuelle : ${{ steps.release.outputs.version }}**
            [![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/${{ steps.release.outputs.version }}/all_packages-x86-${{ steps.release.outputs.version }}.zip) &nbsp; [![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/${{ steps.release.outputs.version }}/mikrotik-${{ steps.release.outputs.version }}.iso.zip) &nbsp; [![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/${{ steps.release.outputs.version }}/install-image-${{ steps.release.outputs.version }}-.img.zip) &nbsp; [![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/${{ steps.release.outputs.version }}/chr-${{ steps.release.outputs.version }}-vmdk.zip) &nbsp; [![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)](https://github.com/optinettogo/RouterOsPatchs/releases/download/${{ steps.release.outputs.version }}/chr-${{ steps.release.outputs.version }}-.qcow2.zip)
        run: |
          # 1. Sauvegarde du contenu dans un fichier temporaire
          echo "$TABLE_CONTENT" > /tmp/content.txt
          
          # 2. NETTOYAGE : Supprime tout ce qu'il y a entre les balises (idempotent)
          sed -i '//,//{//!d}' README.md
          
          # 3. INJECTION : InsÃ¨re le nouveau contenu
          sed -i '//r /tmp/content.txt' README.md

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸš€ Auto-update README for version ${{ steps.release.outputs.version }}" || exit 0
          git push origin main
