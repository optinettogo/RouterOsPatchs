name: Update README on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout EXPLICITE de la branche main (cl√© contre detached HEAD)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 2Ô∏è‚É£ R√©cup√©ration du tag de la release (ex: 7.20)
      - name: Get release version
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # 3Ô∏è‚É£ G√©n√©ration du bloc AUTO-RELEASE
      - name: Update README download links
        run: |
          VERSION="${{ steps.release.outputs.version }}"

          X86="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/all_packages-x86-$VERSION.zip"
          ISO="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/mikrotik-$VERSION.iso.zip"
          IMG="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/install-image-$VERSION.img.zip"
          VMDK="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION-vmdk.zip"
          QCOW2="https://github.com/optinettogo/RouterOsPatchs/releases/download/$VERSION/chr-$VERSION.qcow2.zip"

          cat <<EOF > /tmp/auto_release_block.txt
<!-- AUTO-RELEASE-START -->

### üìÇ **Tableau des Ressources v7 (Stable)**

**Version actuelle : $VERSION**

[![X86](https://img.shields.io/badge/Packages-X86-orange?style=plastic&logo=mikrotik&logoColor=white)]($X86)
[![ISO](https://img.shields.io/badge/Image--ISO-red?style=plastic&logo=mikrotik&logoColor=white)]($ISO)
[![IMG](https://img.shields.io/badge/Image--Disk-grey?style=plastic&logo=mikrotik&logoColor=white)]($IMG)
[![VMware](https://img.shields.io/badge/(VMDK)-VMware-blueviolet?style=plastic&logo=mikrotik&logoColor=white)]($VMDK)
[![GNS3](https://img.shields.io/badge/(QCOW2)-GNS3Lab-047AD0?style=plastic&logo=gns3&logoColor=white)]($QCOW2)

<!-- AUTO-RELEASE-END -->
EOF

          awk '
            BEGIN {inblock=0}
            /<!-- AUTO-RELEASE-START -->/ {inblock=1; system("cat /tmp/auto_release_block.txt"); next}
            /<!-- AUTO-RELEASE-END -->/ {inblock=0; next}
            !inblock {print}
          ' README.md > README.new && mv README.new README.md

      # 4Ô∏è‚É£ Commit + PUSH EXPLICITE vers main (FIN du probl√®me)
      - name: Commit and push README
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "Aucune modification d√©tect√©e."
            exit 0
          fi

          git commit -m "üöÄ Auto-update README links to version ${{ steps.release.outputs.version }}"
          git push origin HEAD:main
